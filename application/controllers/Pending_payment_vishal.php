<?php
defined('BASEPATH') or exit('No direct script access allowed');
class Pending_payment_vishal extends CI_Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->load->helper('master_helper');
        $this->load->model('master_model');
        $this->load->model('billdesk_pg_model');
    }

    public function sbicallback()
    {
        exit();
        $str = '';

  

        // $sql = "SELECT receipt_no, gateway,status FROM `payment_transaction` WHERE DATE(`date`) BETWEEN '2022-07-08 00:00:00.000000' AND '2022-07-10 00:00:00.000000' AND `status` IN (2,0) AND exam_code != '991' ";

        $sql       = "SELECT receipt_no, gateway,status FROM `payment_transaction` Where status IN (2,0) AND exam_code != 991 AND date LIKE '%22-07-07%'";

        $record = $this->db->query($sql);

        if ($record->num_rows()) {
            foreach ($record->result_array() as $c_row) {

                if ($c_row['gateway'] == 'billdesk') {
                    $responsedata   = $this->billdesk_pg_model->billdeskqueryapi($c_row['receipt_no']);
                    $payment_status = $responsedata['transaction_error_type'];
                    $auth_status    = $responsedata['auth_status'];
                }

                $encData   = implode('|', $responsedata);
                $resp_data = json_encode($responsedata);

                $resp_array = array('receipt_no' => $c_row['receipt_no'],
                    'txn_status'                     => $payment_status,
                    'txn_data'                       => $encData . '&CALLBACK=C_S2S',
                    'response_data'                  => $resp_data,
                    'remark'                         => '',
                    'resp_date'                      => date('Y-m-d H:i:s'),
                );
                $this->master_model->insertRecord('pending_payment', $resp_array);

                if ($auth_status == "0300") {
                    if ($c_row['gateway'] == 'billdesk') {

                        $headers = array(
                            'alg'      => $this->config->item('BD_ALG'), //'HS256',
                            'clientid' => $this->config->item('BD_CLIENTID'), //'uatiibfv2'
                        );
                        $key                = $this->config->item('BD_KEY'); //'dEjcgb0OQpLeC4gApFpL5msdPxHt0w79';
                        $random_trace       = substr(md5(mt_rand()), 0, 7);
                        $refund_url         = $this->config->item('BD_REFUND_URL'); //'https://pguat.billdesk.io/payments/ve1_2/refunds/create';
                        $mercid             = $this->config->item('BD_MERCID'); //'UATIIBFV2';
                        $orderId            = $c_row['receipt_no']; //'900485161';  Test number
                        $txn_id             = $responsedata['transactionid'];
                        $txn_date           = $responsedata['transaction_date'];
                        $txn_amount         = $responsedata['amount'];
                        $currency           = $responsedata['currency'];
                        $merc_refund_ref_no = 'REF_' . $orderId;
                        $payload            = [
                            "transactionid"      => $txn_id,
                            "orderid"            => $orderId,
                            "mercid"             => $mercid,
                            "transaction_date"   => $txn_date,
                            "txn_amount"         => $txn_amount,
                            "refund_amount"      => $txn_amount,
                            "currency"           => $currency,
                            "merc_refund_ref_no" => $merc_refund_ref_no,
                        ];
                        //echo '<br/> Payload : <pre>';    print_r($payload); echo '</pre>';

                        $jws       = new \Gamegos\JWS\JWS();
                        $jwsString = $jws->encode($headers, $payload, $key);
                        //echo "<br/>".$jwsString."<br/>";

                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $refund_url);
                        // Set HTTP Header for POST request
                        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                            'Content-Type: application/jose',
                            'accept: application/jose',
                            'bd-traceid: ' . time() . $random_trace, //'REF1K',
                            'bd-timestamp: ' . time())
                        );
                        curl_setopt($ch, CURLOPT_POST, true);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $jwsString);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                        $info = curl_getinfo($ch);
                        //print_r($info);
                        $result = curl_exec($ch);
                        curl_close($ch);
                        $refund_result = $jws->verify($result, $key);

                        if ($refund_result['payload']['objectid'] == 'refund') {
                            $pr_status  = 3;
                            $update_arr = array('status' => $pr_status, 'callback' => 'PSS2S');
                            $where_arr  = array('receipt_no' => $c_row['receipt_no']);
                            $this->master_model->updateRecord('payment_transaction', $update_arr, $where_arr);
                            echo $str .= $this->db->last_query() . '\n';
                        }

                    }

                } else {
                    if ($auth_status == "0399") {
                        $tra_status = 'FAIL';
                        $status     = 0;
                    } else if ($auth_status == "0799") {
                        $status     = 4;
                        $tra_status = "refund";
                    } else {
                        $status     = 0;
                        $tra_status = "FAIL";
                    }
                    $update_arr = array('status' => $status, 'transaction_details' => $tra_status, 'callback' => 'PSS2S');
                    $where_arr  = array('receipt_no' => $c_row['receipt_no']);
                    $this->master_model->updateRecord('payment_transaction', $update_arr, $where_arr);

                    echo $str .= $this->db->last_query() . '\n';
                }
            }

        }

    }

    function check_status(){
       
        $receipt_no = [903509104,903508566,903508551,903508540,903508531,903508508,903508507,903508502,903508497,903508369,903508315,903508307,903508300,903508299,903508273,903508268,903508255,903508585,903508603,903509098,903509094,903509091,903509078,903509073,903509062,903509002,903508994,903508857,903508660,903508659,903508649,903508645,903508633,903508631,903508627,903508246,903508236,903507997,903507995,903507992,903507984,903507982,903507976,903507959,903507941,903507929,903507927,903507916,903507911,903507903,903507896,903507889,903507888,903508000,903508002,903508231,903508228,903508223,903508221,903508205,903508196,903508187,903508181,903508177,903508175,903508150,903508065,903508035,903508020,903508016,903508008,903507887,903509105,903515965,903515813,903515812,903515795,903515756,903515733,903515728,903515715,903512434,903511644,903511600,903511538,903511534,903511510,903511478,903511454,903511420,903515827,903515840,903515957,903515949,903515909,903515898,903515893,903515887,903515886,903515885,903515875,903515871,903515867,903515866,903515851,903515849,903515848,903515841,903511372,903511346,903510108,903509747,903509696,903509682,903509609,903509598,903509584,903509535,903509529,903509525,903509518,903509517,903509503,903509486,903509246,903509227,903510137,903510458,903511303,903511129,903511108,903511097,903510961,903510959,903510711,903510666,903510650,903510639,903510630,903510616,903510573,903510529,903510506,903510491,903509106,903506936,903506854,903506846,903506827,903506790,903506762,903506745,903506721,903506720,903506719,903506708,903506706,903506703,903506701,903506699,903506698,903506691,903506856,903506866,903506932,903506930,903506929,903506927,903506925,903506923,903506920,903506893,903506881,903506878,903506875,903506873,903506871,903506870,903506868,903506867,903506687,903506685,903505642,903505633,903505511,903505493,903504797,903504753,903504689,903504618,903504602,903504576,903504514,903504497,903502351,903501789,903499826,903499559,903506225,903506269,903506667,903506666,903506663,903506659,903506654,903506652,903506583,903506541,903506535,903506512,903506416,903506408,903506404,903506396,903506276,903506273,903496828,903506937,903507877,903507471,903507470,903507467,903507461,903507460,903507459,903507457,903507454,903507450,903507443,903507442,903507400,903507396,903507377,903507373,903507357,903507473,903507480,903507874,903507866,903507861,903507838,903507830,903507701,903507664,903507658,903507636,903507613,903507612,903507596,903507488,903507487,903507485,903507483,903507349,903507188,903506982,903506980,903506979,903506973,903506969,903506968,903506964,903506963,903506961,903506960,903506959,903506958,903506954,903506953,903506950,903506945,903506983,903506985,903507186,903507184,903507171,903507166,903507163,903507160,903507107,903507101,903507099,903507094,903507087,903507085,903507078,903507050,903507041,903507037,903506940];

        foreach ($receipt_no as  $key=>$value) {
    
                $responsedata   = $this->billdesk_pg_model->billdeskqueryapi($value);
                echo $key.">>>".$value.">>>".$responsedata['auth_status'];echo "<br>";
        }



    }

    function arraydiff(){
        $array1 = [801991353,801993009,801993019,801993043,801995278,801995283,801995323,801995407,801996058,801996065,801997109,801997124,801997161,801997287,801997764,801998287,802020178,802020778,802020867,802021418,802021631,802022966,802022972,802023021,802023034,802023043,802023095,802023105,802023137,802023533,802023561,802023689,802023696,802024123,802024321,802024342,802024350,802031878,802031891,802031917,802031938,802032422,802032553,802032592,802032783,802032929,802032936,802032957,802032984,802033035,802033032,802033112,802033125,802033142,802033156,802033159,802033164,802033172,802033187,802033415,802033889,802034075,802034078,802034248,802034318,802034481,802034627,802034769,802034797,802034798,802034807,802034815,802034824,802034843,802034841,802034861,802034864,802034878,802034981,802035036,802035175,802035187,802035196,802035202,802035223,802035227,802035287,802035290,802035291,802035292,802035293,802035301,802035315,802035317,802035332,802035339,802035350,802035355,802035360,802035361,802035366,802035368,802035377,802035412,802035422,802035423,802035424,802035446,802035814,802035836,802035963,802036146,802036270,802036280,802036391,802036477,802036492,802036557,802036857,802036861,802036871,802036894,802036983,802036998,802037098,802038802,802038868,802038930,802038950,802039000,802039020,802039318,802039331,802039387,802039405,802039411,802039424,802039422,802039420,802039441,802039450,802039459,802039488,802039506,802039511,802039518,802039527,802039542,802040549,802039912,802039917,802039952,802039982,802039997,802040039,802040280,802040288,802040317,802040354,802040360,802040365,802040380,802040377,802040379,802040388,802040397,802040415,802040422,802040440,802040439,802040458,802040498,802040506,802040515,802040521,802040526,802040533,802042621,802040536,802040546,802040557,802040563,802040567,802040589,802040659,802040786,802040864,802040861,802040857,802040867,802040866,802040887,802040896,802040895,802040904,802040912,802040922,802040939,802040961,802040970,802040978,802041012,802041014,802041029,802041058,802041148,802041277,802041288,802041298,802041302,802041352,802041369,802042625,802041407,802041414,802041423,802041439,802041440,802041444,802041453,802041460,802041469,802042627,802042287,802042476,802042481,802042564,802042576,802042579,802042590,802042593,802042598,802042605,802042616,802042612,802042769,802042783,802043026,802043082,802043085,802043087,802043132,802043136,802043142,802043191,802043197,802043204,802043244,802043251,802043293,802044475,802044485,802044710,802044772,802044797,802044815,802044891,802044946,802044963,802044981,802044989,802045014,802045068,802045372,802045364,802045365,802045397,802045450,802045496,802045511,802045523,802045707,802045741,802045792,802045829,802045858,802045894,802045930,802045959,802045987,802046000,802046060,802046109,802046367,802055205,802055212,802055238,802055251,802055252,802055262,802055284,802055282,802055306,802055314,802055424,802055946,802055944,802055966,802055971,802055973,802055988,802055987,802056002,802056008,802056011,802056012,802056014,802056019,802056031,802056033,802056037,802056057,802056102,802056105,802056117,802056121,802056138,802056144,802056189,802056304,802056343,802056358];

        $array2 = [802042579,802041298,802041288,802041277,802041148,802041058,802041029,802041014,802041012,802040978,802040970,802040961,802040939,802040922,802040912,802040904,802040895,802040896,802041302,802041352,802042576,802042564,802042481,802042476,802042287,802042627,802041469,802041460,802041453,802041444,802041440,802041439,802041423,802041414,802041407,802042625,802041369,802040887,802040866,802040458,802040439,802040440,802040422,802040415,802040397,802040388,802040379,802040377,802040380,802040365,802040360,802040354,802040317,802040288,802040280,802040039,802040498,802040506,802040864,802040867,802040857,802040861,802040786,802040659,802040589,802040567,802040563,802040557,802040546,802040536,802042621,802040533,802040526,802040521,802040515,802039997,802042590,802056358,802055946,802055424,802055314,802055251,802055238,802055212,802046367,802046109,802046060,802046000,802045987,802045959,802045930,802045894,802045858,802045829,802045792,802055944,802055971,802056343,802056304,802056189,802056144,802056121,802056117,802056105,802056102,802056057,802056037,802056033,802056031,802056011,802056008,802056002,802055987,802055988,802045741,802045523,802043244,802043204,802043197,802043191,802043142,802043136,802043132,802043087,802043085,802043082,802043026,802042783,802042769,802042612,802042616,802042605,802042598,802043251,802043293,802045511,802045496,802045365,802045364,802045068,802045014,802044989,802044981,802044963,802044946,802044891,802044815,802044797,802044772,802044710,802044485,802044475,802042593,802034861,802033159,802033156,802033142,802033125,802033112,802033032,802033035,802032984,802032957,802032936,802032929,802032783,802032592,802032553,802032422,802031938,802031917,802033164,802033172,802034843,802034841,802034824,802034815,802034807,802034798,802034797,802034769,802034627,802034481,802034318,802034248,802034078,802034075,802033889,802033415,802033187,802031891,802031878,802020778,802020178,801998287,801997764,801997287,801997161,801997124,801997109,801996065,801996058,801995407,801995323,801995283,801995278,801993043,801993019,801993009,802020867,802021418,802024350,802024342,802024321,802024123,802023696,802023689,802023561,802023533,802023137,802023105,802023095,802023043,802023034,802023021,802022972,802022966,802021631,801991353,802034864,802039982,802039331,802039318,802039020,802039000,802038950,802038930,802038868,802038802,802037098,802036998,802036983,802036894,802036871,802036861,802036857,802036557,802036492,802039387,802039405,802039952,802039917,802039912,802040549,802039542,802039527,802039518,802039511,802039506,802039488,802039459,802039450,802039441,802039420,802039422,802039424,802039411,802036477,802036391,802035332,802035317,802035315,802035301,802035293,802035292,802035291,802035290,802035287,802035227,802035223,802035202,802035196,802035187,802035175,802035036,802034981,802035339,802035350,802036280,802036270,802036146,802035963,802035836,802035814,802035446,802035424,802035423,802035422,802035412,802035377,802035368,802035366,802035361,802035360,802035355,802034878];
        echo "<pre>";
        print_r(array_diff($array1, $array2));
    }
}
